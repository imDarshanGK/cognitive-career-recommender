{% extends "layout/base.html" %}

{% block title %}Profile Settings - Cognitive Career AI{% endblock %}

{% block extra_css %}
<link href="{{ url_for('static', filename='css/dashboard.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-lg-3">
            <div class="profile-sidebar">
                <div class="card">
                    <div class="card-body text-center">
                        <!-- Profile Avatar -->
                        <div class="profile-avatar-container mb-3">
                            <img src="{{ current_user.avatar_url or url_for('static', filename='images/default-avatar.png') }}" 
                                 alt="Profile Picture" 
                                 class="profile-avatar rounded-circle" 
                                 id="profileImage">
                            <div class="avatar-overlay">
                                <i class="fas fa-camera"></i>
                            </div>
                            <input type="file" id="avatarInput" accept="image/*" class="d-none">
                        </div>
                        
                        <!-- Basic Info -->
                        <h5 class="mb-1">{{ current_user.full_name }}</h5>
                        <p class="text-muted small mb-2">{{ current_user.profession or 'Professional' }}</p>
                        <p class="text-muted small">Member since {{ current_user.created_at.strftime('%B %Y') }}</p>
                        
                        <!-- AI Score -->
                        <div class="ai-score-card mt-3">
                            <div class="ai-score-circle">
                                <span class="score-number">{{ current_user.ai_score or 85 }}</span>
                                <small class="score-label">AI Score</small>
                            </div>
                            <small class="text-muted">Career Match Rating</small>
                        </div>
                    </div>
                </div>
                
                <!-- Profile Navigation -->
                <div class="card mt-3">
                    <div class="list-group list-group-flush">
                        <a href="#personal-info" class="list-group-item list-group-item-action active" data-tab="personal-info">
                            <i class="fas fa-user me-2"></i>Personal Information
                        </a>
                        <a href="#professional-info" class="list-group-item list-group-item-action" data-tab="professional-info">
                            <i class="fas fa-briefcase me-2"></i>Professional Details
                        </a>
                        <a href="#preferences" class="list-group-item list-group-item-action" data-tab="preferences">
                            <i class="fas fa-cog me-2"></i>Preferences
                        </a>
                        <a href="#security" class="list-group-item list-group-item-action" data-tab="security">
                            <i class="fas fa-shield-alt me-2"></i>Security Settings
                        </a>
                        <a href="#notifications" class="list-group-item list-group-item-action" data-tab="notifications">
                            <i class="fas fa-bell me-2"></i>Notifications
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="col-lg-9">
            <!-- Personal Information Tab -->
            <div class="tab-content" id="personal-info">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-user me-2"></i>Personal Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="personalInfoForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="firstName" class="form-label">First Name</label>
                                    <input type="text" class="form-control" id="firstName" name="first_name" 
                                           value="{{ current_user.first_name }}" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="lastName" class="form-label">Last Name</label>
                                    <input type="text" class="form-control" id="lastName" name="last_name" 
                                           value="{{ current_user.last_name }}" required>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="email" class="form-label">Email Address</label>
                                    <input type="email" class="form-control" id="email" name="email" 
                                           value="{{ current_user.email }}" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="phone" class="form-label">Phone Number</label>
                                    <input type="tel" class="form-control" id="phone" name="phone" 
                                           value="{{ current_user.phone or '' }}">
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="dateOfBirth" class="form-label">Date of Birth</label>
                                    <input type="date" class="form-control" id="dateOfBirth" name="date_of_birth" 
                                           value="{{ current_user.date_of_birth.isoformat() if current_user.date_of_birth else '' }}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="location" class="form-label">Location</label>
                                    <input type="text" class="form-control" id="location" name="location" 
                                           value="{{ current_user.location or '' }}" placeholder="City, Country">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="bio" class="form-label">Professional Bio</label>
                                <textarea class="form-control" id="bio" name="bio" rows="4" 
                                          placeholder="Tell us about your professional background and career goals...">{{ current_user.bio or '' }}</textarea>
                                <div class="form-text">Max 500 characters</div>
                            </div>
                            
                            <div class="d-flex justify-content-end">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Save Changes
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Professional Information Tab -->
            <div class="tab-content d-none" id="professional-info">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-briefcase me-2"></i>Professional Details
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="professionalInfoForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="currentTitle" class="form-label">Current Job Title</label>
                                    <input type="text" class="form-control" id="currentTitle" name="current_title" 
                                           value="{{ current_user.current_title or '' }}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="company" class="form-label">Current Company</label>
                                    <input type="text" class="form-control" id="company" name="company" 
                                           value="{{ current_user.company or '' }}">
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="industry" class="form-label">Industry</label>
                                    <select class="form-select" id="industry" name="industry">
                                        <option value="">Select Industry</option>
                                        <option value="Technology">Technology</option>
                                        <option value="Healthcare">Healthcare</option>
                                        <option value="Finance">Finance</option>
                                        <option value="Education">Education</option>
                                        <option value="Manufacturing">Manufacturing</option>
                                        <option value="Consulting">Consulting</option>
                                        <option value="Marketing">Marketing</option>
                                        <option value="Sales">Sales</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="experienceLevel" class="form-label">Experience Level</label>
                                    <select class="form-select" id="experienceLevel" name="experience_level">
                                        <option value="">Select Experience Level</option>
                                        <option value="Entry Level">Entry Level (0-2 years)</option>
                                        <option value="Mid Level">Mid Level (3-5 years)</option>
                                        <option value="Senior Level">Senior Level (6-10 years)</option>
                                        <option value="Executive">Executive (10+ years)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="skills" class="form-label">Skills & Technologies</label>
                                <input type="text" class="form-control" id="skills" name="skills" 
                                       value="{{ current_user.skills_list|join(', ') if current_user.skills_list else '' }}"
                                       placeholder="Python, JavaScript, Project Management, Data Analysis">
                                <div class="form-text">Separate skills with commas</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="careerGoals" class="form-label">Career Goals</label>
                                <textarea class="form-control" id="careerGoals" name="career_goals" rows="3" 
                                          placeholder="Describe your short-term and long-term career objectives...">{{ current_user.career_goals or '' }}</textarea>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="salaryExpectation" class="form-label">Salary Expectation</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="salaryExpectation" name="salary_expectation" 
                                               value="{{ current_user.salary_expectation or '' }}">
                                        <span class="input-group-text">/ year</span>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="willingToRelocate" class="form-label">Willing to Relocate?</label>
                                    <select class="form-select" id="willingToRelocate" name="willing_to_relocate">
                                        <option value="">Select Option</option>
                                        <option value="Yes">Yes</option>
                                        <option value="No">No</option>
                                        <option value="Maybe">Maybe</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-end">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Save Changes
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- More tab content sections would go here... -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Tab switching
    const tabLinks = document.querySelectorAll('[data-tab]');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Remove active class from all links
            tabLinks.forEach(l => l.classList.remove('active'));
            
            // Add active class to clicked link
            this.classList.add('active');
            
            // Hide all tab contents
            tabContents.forEach(content => content.classList.add('d-none'));
            
            // Show selected tab content
            const targetTab = document.getElementById(this.getAttribute('data-tab'));
            if (targetTab) {
                targetTab.classList.remove('d-none');
            }
        });
    });
    
    // Profile image upload
    const profileImage = document.getElementById('profileImage');
    const avatarInput = document.getElementById('avatarInput');
    const avatarOverlay = document.querySelector('.avatar-overlay');
    
    avatarOverlay.addEventListener('click', function() {
        avatarInput.click();
    });
    
    avatarInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                profileImage.src = e.target.result;
                uploadAvatar(file);
            };
            reader.readAsDataURL(file);
        }
    });
    
    // Form submissions
    document.getElementById('personalInfoForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveProfileData('personal', new FormData(this));
    });
    
    document.getElementById('professionalInfoForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveProfileData('professional', new FormData(this));
    });
    
    function saveProfileData(type, formData) {
        const submitBtn = event.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        // Show loading state
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';
        submitBtn.disabled = true;
        
        fetch('{{ url_for("auth.update_profile") }}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', 'Profile updated successfully!');
            } else {
                showAlert('error', data.message || 'Failed to update profile');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('error', 'Network error. Please try again.');
        })
        .finally(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
    }
    
    function uploadAvatar(file) {
        const formData = new FormData();
        formData.append('avatar', file);
        
        fetch('{{ url_for("auth.upload_avatar") }}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', 'Profile picture updated successfully!');
            } else {
                showAlert('error', data.message || 'Failed to update profile picture');
                // Revert image on error
                profileImage.src = '{{ current_user.avatar_url or url_for("static", filename="images/default-avatar.png") }}';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('error', 'Failed to upload image. Please try again.');
            profileImage.src = '{{ current_user.avatar_url or url_for("static", filename="images/default-avatar.png") }}';
        });
    }
    
    function showAlert(type, message) {
        const alertHtml = `
            <div class="alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show" role="alert">
                <i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'check-circle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        const container = document.querySelector('.container');
        if (container) {
            container.insertAdjacentHTML('afterbegin', alertHtml);
        }
    }
});
</script>
{% endblock %}