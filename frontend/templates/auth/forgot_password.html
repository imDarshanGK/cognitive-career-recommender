{% extends "layout/auth_base.html" %}

{% block title %}Reset Password - Cognitive Career AI{% endblock %}

{% block auth_title %}Reset Your Password{% endblock %}
{% block auth_subtitle %}Enter your email address and we'll send you a link to reset your password{% endblock %}

{% block auth_content %}
<form method="POST" id="forgotPasswordForm" novalidate>
    
    <!-- Email Field -->
    <div class="mb-4">
        <label for="email" class="form-label">
            <i class="fas fa-envelope me-1"></i>Email Address
        </label>
        <input type="email" 
               class="form-control form-control-lg" 
               id="email" 
               name="email" 
               placeholder="Enter your registered email"
               value=""
               required>
        <div class="invalid-feedback" id="email-error"></div>
        <div class="form-text">
            We'll send password reset instructions to this email address.
        </div>
    </div>
    
    <!-- Submit Button -->
    <button type="submit" class="btn btn-primary btn-lg w-100 mb-3" id="resetBtn">
        <span class="btn-text">
            <i class="fas fa-paper-plane me-2"></i>Send Reset Link
        </span>
        <span class="btn-loading d-none">
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            Sending...
        </span>
    </button>
    
    <!-- Security Info -->
    <div class="alert alert-info" role="alert">
        <i class="fas fa-shield-alt me-2"></i>
        <strong>Security Notice:</strong> For your protection, the reset link will expire in 1 hour.
    </div>
</form>

<!-- Success State (Hidden by default) -->
<div id="successState" class="d-none text-center">
    <div class="mb-4">
        <i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>
    </div>
    <h4 class="text-success mb-3">Reset Link Sent!</h4>
    <p class="text-muted mb-4">
        We've sent password reset instructions to <strong id="sentEmail"></strong>. 
        Please check your inbox and follow the instructions to reset your password.
    </p>
    <div class="alert alert-warning" role="alert">
        <i class="fas fa-info-circle me-2"></i>
        Didn't receive the email? Check your spam folder or 
        <button type="button" class="btn btn-link p-0 align-baseline" id="resendBtn">
            click here to resend
        </button>
    </div>
</div>
{% endblock %}

{% block auth_footer %}
<div class="text-center">
    <p class="text-muted mb-2">
        <a href="{{ url_for('auth.login') }}" class="text-decoration-none">
            <i class="fas fa-arrow-left me-1"></i>Back to Login
        </a>
    </p>
    <p class="text-muted mb-0">
        Don't have an account? 
        <a href="{{ url_for('auth.register') }}" class="text-decoration-none fw-semibold">
            Sign up here
        </a>
    </p>
</div>
{% endblock %}

{% block auth_links %}
<div class="small text-muted">
    <a href="{{ url_for('main.privacy') }}" class="text-decoration-none me-3">Privacy Policy</a>
    <a href="{{ url_for('main.terms') }}" class="text-decoration-none me-3">Terms of Service</a>
    <a href="{{ url_for('main.support') }}" class="text-decoration-none">Support</a>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('forgotPasswordForm');
    const resetBtn = document.getElementById('resetBtn');
    const successState = document.getElementById('successState');
    const resendBtn = document.getElementById('resendBtn');
    let sentEmail = '';
    
    // Form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Clear previous errors
        clearErrors();
        
        const email = document.getElementById('email').value;
        if (!email) {
            showError('email', 'Email address is required');
            return;
        }
        
        // Show loading state
        setLoadingState(true);
        
        // Submit request
        submitResetRequest(email);
    });
    
    // Resend button
    resendBtn.addEventListener('click', function() {
        if (sentEmail) {
            setLoadingState(true);
            submitResetRequest(sentEmail);
        }
    });
    
    function submitResetRequest(email) {
        const formData = new FormData();
        formData.append('email', email);
        formData.append('csrf_token', '{{ csrf_token() }}');
        
        fetch('{{ url_for("auth.forgot_password") }}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success state
                sentEmail = email;
                document.getElementById('sentEmail').textContent = email;
                form.classList.add('d-none');
                successState.classList.remove('d-none');
                
                showAlert('success', 'Reset instructions sent successfully!');
            } else {
                if (data.errors) {
                    showErrors(data.errors);
                } else {
                    showAlert('error', data.message || 'Failed to send reset email. Please try again.');
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('error', 'Network error. Please check your connection and try again.');
        })
        .finally(() => {
            setLoadingState(false);
        });
    }
    
    function setLoadingState(loading) {
        const btnText = resetBtn.querySelector('.btn-text');
        const btnLoading = resetBtn.querySelector('.btn-loading');
        
        if (loading) {
            btnText.classList.add('d-none');
            btnLoading.classList.remove('d-none');
            resetBtn.disabled = true;
            resendBtn.disabled = true;
        } else {
            btnText.classList.remove('d-none');
            btnLoading.classList.add('d-none');
            resetBtn.disabled = false;
            resendBtn.disabled = false;
        }
    }
    
    function clearErrors() {
        document.querySelectorAll('.is-invalid').forEach(input => {
            input.classList.remove('is-invalid');
        });
        document.querySelectorAll('.invalid-feedback').forEach(error => {
            error.textContent = '';
        });
    }
    
    function showError(field, message) {
        const input = document.getElementById(field);
        const errorDiv = document.getElementById(field + '-error');
        
        if (input && errorDiv) {
            input.classList.add('is-invalid');
            errorDiv.textContent = message;
        }
    }
    
    function showErrors(errors) {
        Object.keys(errors).forEach(field => {
            showError(field, Array.isArray(errors[field]) ? errors[field][0] : errors[field]);
        });
    }
    
    function showAlert(type, message) {
        const alertHtml = `
            <div class="alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show" role="alert">
                <i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'check-circle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        const container = document.querySelector('.auth-card-body');
        if (container) {
            container.insertAdjacentHTML('afterbegin', alertHtml);
        }
    }
});
</script>
{% endblock %}