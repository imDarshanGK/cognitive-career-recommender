{% extends "layout/auth_base.html" %}

{% block title %}Reset Password - CareerAI{% endblock %}

{% block auth_title %}Reset Your Password{% endblock %}
{% block auth_subtitle %}Enter your email address and we'll send a reset link{% endblock %}

{% block auth_content %}
<form method="POST" action="/forgot-password" id="forgotPasswordForm" novalidate>
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    
    <!-- Email Field -->
    <div class="mb-4">
        <label for="email" class="form-label">
            <i class="fas fa-envelope me-1"></i>Email Address
        </label>
        <input type="email" 
               class="form-control form-control-lg" 
               id="email" 
               name="email" 
               placeholder="Enter your registered email"
               value=""
               required>
        <div class="invalid-feedback" id="email-error"></div>
        <div class="form-text">
            We'll send reset instructions to this email address.
        </div>
    </div>
    
    <!-- Submit Button -->
    <button type="submit" class="btn btn-primary btn-lg w-100 mb-3" id="resetBtn">
        <span class="btn-text">
            <i class="fas fa-paper-plane me-2"></i>Send Reset Link
        </span>
        <span class="btn-loading d-none">
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            Sending...
        </span>
    </button>
    
    <!-- Security Info -->
    <div class="alert alert-info" role="alert">
        <i class="fas fa-shield-alt me-2"></i>
        <strong>Security Notice:</strong> For your protection, the reset link will expire in 1 hour.
    </div>
</form>

<!-- Success State (Hidden by default) -->
<div id="successState" class="d-none text-center">
    <div class="mb-4">
        <i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>
    </div>
    <h4 class="text-success mb-3">Reset Link Sent!</h4>
    <p class="text-muted mb-4">
        We've sent password reset instructions to <strong id="sentEmail"></strong>. 
        Please check your inbox and follow the instructions to reset your password.
    </p>
    <div class="alert alert-warning" role="alert">
        <i class="fas fa-info-circle me-2"></i>
        Didn't receive the email? Check your spam folder or 
        <button type="button" class="btn btn-link p-0 align-baseline" id="resendBtn">
            click here to resend
        </button>
    </div>
</div>
{% endblock %}

{% block auth_footer %}
<div class="text-center">
    <p class="text-muted mb-2">
        <a href="/login" class="text-decoration-none">
            <i class="fas fa-arrow-left me-1"></i>Back to Login
        </a>
    </p>
    <p class="text-muted mb-0">
        Don't have an account?
        <a href="/register" class="text-decoration-none fw-semibold">
            Sign up here
        </a>
    </p>
</div>
{% endblock %}

{% block auth_links %}
<div class="small text-muted">
    <a href="/" class="text-decoration-none me-3">Home</a>
    <a href="/register" class="text-decoration-none me-3">Get Started</a>
    <a href="/login" class="text-decoration-none">Login</a>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('forgotPasswordForm');
    const resetBtn = document.getElementById('resetBtn');
    const successState = document.getElementById('successState');
    const resendBtn = document.getElementById('resendBtn');
    let sentEmail = '';
    
    // Form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const email = document.getElementById('email').value.trim();
        if (!email) {
            document.getElementById('email-error').textContent = 'Email address is required';
            document.getElementById('email').classList.add('is-invalid');
            return;
        }
        
        // Show loading state
        resetBtn.disabled = true;
        resetBtn.querySelector('.btn-text').classList.add('d-none');
        resetBtn.querySelector('.btn-loading').classList.remove('d-none');
        
        // Submit request
        submitResetRequest(email);
    });
    
    // Resend button
    resendBtn.addEventListener('click', function() {
        if (sentEmail) {
            resetBtn.disabled = true;
            resetBtn.querySelector('.btn-text').classList.add('d-none');
            resetBtn.querySelector('.btn-loading').classList.remove('d-none');
            submitResetRequest(sentEmail);
        }
    });
    
    function submitResetRequest(email) {
        const formData = new FormData();
        formData.append('email', email);
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
        if (csrfToken) {
            formData.append('csrf_token', csrfToken);
        }
        
        fetch('/forgot-password', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                ...(csrfToken ? { 'X-CSRFToken': csrfToken } : {})
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success state
                sentEmail = email;
                document.getElementById('sentEmail').textContent = email;
                form.classList.add('d-none');
                successState.classList.remove('d-none');
            } else {
                document.getElementById('email-error').textContent = data.message || 'An error occurred';
                document.getElementById('email').classList.add('is-invalid');
                resetBtn.disabled = false;
                resetBtn.querySelector('.btn-text').classList.remove('d-none');
                resetBtn.querySelector('.btn-loading').classList.add('d-none');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('email-error').textContent = 'Network error. Please try again.';
            document.getElementById('email').classList.add('is-invalid');
            resetBtn.disabled = false;
            resetBtn.querySelector('.btn-text').classList.remove('d-none');
            resetBtn.querySelector('.btn-loading').classList.add('d-none');
        });
    }
});
</script>
{% endblock %}